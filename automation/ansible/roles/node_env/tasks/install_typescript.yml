---
- name: Install TypeScript via npm for dev_user
  become: true
  become_user: "{{ dev_user }}"
  tags: [typescript, node, devtools]
  block:
    - name: Check if TypeScript is already installed
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        command -v tsc >/dev/null 2>&1
      args:
        executable: /bin/bash
      register: typescript_installed
      changed_when: false
      failed_when: false

    - name: Install TypeScript globally via npm
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        npm install -g typescript
      args:
        executable: /bin/bash
      changed_when: true
      when: typescript_installed.rc != 0

    - name: Verify TypeScript installation
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        tsc --version
      args:
        executable: /bin/bash
      register: tsc_version
      changed_when: false
      failed_when: tsc_version.rc != 0

    - name: Display TypeScript version
      ansible.builtin.debug:
        msg: "TypeScript version: {{ tsc_version.stdout }}"
